<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <title>My CDN</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body>

    <div class="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
        {% endif %}
        {% endwith %}
    </div>

    {% if not logged_in %}
    <div class="container login-container">
        <h1>Admin Login</h1>
        <form method="post" action="{{ url_for('index') }}">
            <label for="password">Password:</label>
            <input type="password" name="password" id="password" required>
            <input type="submit" value="Login">
        </form>
    </div>

    {% else %}
    <div class="container">
        <div class="logout-box">
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
        <h1 style="background: radial-gradient(circle, blue, cyan); -webkit-background-clip: text; background-clip: text; color: transparent;">CDN Dashboard</h1>

        <nav class="tab-nav">
            <button class="tab-button {% if active_tab == 'upload' %}active{% endif %}" onclick="showTab('upload', this)">Upload</button>
            <button class="tab-button {% if active_tab == 'manage' %}active{% endif %}" onclick="showTab('manage', this)">Manage Files</button>
        </nav>

        <div id="upload" class="tab-content {% if active_tab == 'upload' %}active{% endif %}">
            <h2>Upload New File(s)</h2>
            <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="active_tab" class="active-tab-input" value="{{ active_tab }}">

                <div class="file-input-container">
                    <label>Select file(s):</label>
                    <div class="file-input-wrapper">
                        <label for="file" class="file-input-label">Choose Files...</label>
                        <input type="file" name="file" id="file" class="file-input-real" required multiple>
                        <span id="file-name-display">No files chosen</span>
                    </div>
                </div>

                <div id="file-options-container"></div>
                
                <input type="submit" value="Upload Files">
            </form>
        </div>

        <div id="manage" class="tab-content {% if active_tab == 'manage' %}active{% endif %}">
            <h2>Manage Uploaded Files</h2>
            
            <div class="search-bar-container">
                <input type="text" id="search-bar" placeholder="Search for files...">
            </div>

            <div class="table-wrapper">
                <table class="file-list-table">
                    <thead>
                        <tr>
                            <th>File Details</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                        <tr 
                            data-filename="{{ file.name }}"
                            data-password-set="{{ 'true' if file.password else 'false' }}"
                            data-raw-password="{{ file.password or '' }}"
                            data-visit-limit="{{ file.visit_limit or '' }}"
                            data-visit-count="{{ file.visit_count or '0' }}"
                        >
                            <td data-label="File Details">
                                <strong class="filename-display">{{ file.name }}</strong>
                                <small class="file-meta-info">{{ file.size }} | {{ file.modified }}</small>
                            </td>
                            <td data-label="Status">
                                <span class="status-tag status-password-{{ 'true' if file.password else 'false' }}">Password</span>
                                <span class="status-tag status-lock-{{ 'true' if file.visit_limit else 'false' }}">
                                    {% if file.visit_limit %}
                                        Lock ({{file.visit_count}}/{{file.visit_limit}})
                                    {% else %}
                                        No Lock
                                    {% endif %}
                                </span>
                            </td>
                            <td data-label="Actions">
                                <div class="action-buttons-wrapper">
                                    <a href="{{ url_for('serve_file', name=file.name) }}" target="_blank" class="action-btn preview-btn">Preview</a>
                                    <button class="action-btn rename-btn" data-action="rename">Rename</button>
                                    <button class="action-btn manage-btn" data-action="password">Password</button>
                                    <button class="action-btn lock-btn" data-action="lock">Lock</button>
                                    <button class="action-btn delete-btn" data-action="delete">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="3" style="text-align:center;">No files found.</td></tr>
                        {% endfor %}
                        <tr id="no-results-row" style="display: none;"><td colspan="3" style="text-align:center;">No files match your search.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="management-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Manage File</h2>
            <div id="modal-body">
            </div>
            <div class="modal-actions">
                <button id="modal-save-btn" class="action-btn save-btn">Save Changes</button>
                <button id="modal-cancel-btn" class="action-btn delete-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="preview-modal" class="modal-overlay">
        <img id="preview-image" alt="Image Preview">
    </div>

    <div class="theme-switcher" id="theme-switcher">
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41zM4.22 18.36l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0zm14.14-14.14l1.41-1.41c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0z"/></svg>
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.37 5.51C9.19 6.15 9.1 6.82 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>
    </div>

<script>
    function showTab(tabName, buttonElement) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        buttonElement.classList.add('active');
        const url = new URL(window.location);
        url.searchParams.set('active_tab', tabName);
        window.history.pushState({}, '', url);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchBar = document.getElementById('search-bar');
        if (searchBar) {
            searchBar.addEventListener('input', function() {
                const searchQuery = this.value.toLowerCase();
                const tableRows = document.querySelectorAll('.file-list-table tbody tr[data-filename]');
                const noResultsRow = document.getElementById('no-results-row');
                let visibleCount = 0;

                tableRows.forEach(row => {
                    const filename = row.dataset.filename.toLowerCase();
                    if (filename.includes(searchQuery)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
            });
        }
        
        document.querySelectorAll('.flash-messages li').forEach(msg => {
            setTimeout(() => {
                msg.classList.add('fading-out');
                setTimeout(() => msg.remove(), 500);
            }, 3000);
        });

        const realFileInput = document.getElementById('file');
        if (realFileInput) {
            realFileInput.addEventListener('change', function() {
                const files = this.files;
                const fileNameDisplay = document.getElementById('file-name-display');
                const fileOptionsContainer = document.getElementById('file-options-container');
                
                fileOptionsContainer.innerHTML = '';

                if (files.length > 0) {
                    fileNameDisplay.textContent = `${files.length} file(s) selected`;

                    Array.from(files).forEach((file, index) => {
                        const fileOptionsHTML = `
                            <div class="file-option-card">
                                <h4>${file.name}</h4>
                                <label for="custom_name_${index}">Custom Name (optional, no extension):</label>
                                <input type="text" name="custom_name" id="custom_name_${index}" placeholder="e.g., my-awesome-image">
                                
                                <label for="password_${index}">Set Password (optional):</label>
                                <input type="password" name="password" id="password_${index}" placeholder="Leave blank for no password">
                                
                                <label for="visit_limit_${index}">Lock After # Visits (optional):</label>
                                <input type="number" name="visit_limit" id="visit_limit_${index}" min="1" placeholder="e.g., 10">
                            </div>
                        `;
                        fileOptionsContainer.insertAdjacentHTML('beforeend', fileOptionsHTML);
                    });

                } else {
                    fileNameDisplay.textContent = 'No files chosen';
                }
            });
        }
        
        const previewModal = document.getElementById('preview-modal');
        if(previewModal) {
            previewModal.addEventListener('click', e => {
                if (e.target === previewModal) previewModal.classList.remove('visible');
            });
        }

        const managementModal = document.getElementById('management-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        let currentAction = null;
        let currentFilename = null;

        function openModal(action, filename, rowData) {
            currentAction = action;
            currentFilename = filename;
            modalTitle.textContent = `Manage ${action.charAt(0).toUpperCase() + action.slice(1)} for "${filename}"`;
            
            let content = '';
            if (action === 'rename') {
                content = `<label for="modal-input">New Name (no extension):</label><input type="text" id="modal-input" class="modal-input-field" placeholder="Enter new name" required>`;
            } else if (action === 'password') {
                content = `<label for="modal-input">New Password:</label><input type="password" id="modal-input" class="modal-input-field" value="${rowData.rawPassword}" placeholder="Leave blank to remove"><p class="modal-note">Set a new password or leave blank to make the file public.</p>`;
            } else if (action === 'lock') {
                content = `<label for="modal-input">Lock after # of visits:</label><input type="number" id="modal-input" min="1" class="modal-input-field" value="${rowData.visitLimit}" placeholder="Leave blank for no limit"><p class="modal-note">The file has been visited ${rowData.visitCount} time(s). Leave blank to remove the visit limit.</p>`;
            }
            modalBody.innerHTML = content;
            managementModal.classList.add('visible');
            document.getElementById('modal-input')?.focus();
        }

        function closeModal() {
            managementModal.classList.remove('visible');
            modalBody.innerHTML = '';
        }

        modalSaveBtn.addEventListener('click', async () => {
            const inputValue = document.getElementById('modal-input')?.value;

            if (currentAction === 'rename') {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = `/rename/${currentFilename}`;
                form.innerHTML = `<input type="hidden" name="active_tab" value="manage"><input type="hidden" name="new_name" value="${inputValue}">`;
                document.body.appendChild(form);
                form.submit();
            } else {
                const endpoint = `/api/file/${currentFilename}/${currentAction}`;
                const payload = currentAction === 'password' ? { password: inputValue } : { limit: inputValue };
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    location.reload(); 
                } catch (e) {
                    alert(`An error occurred: ${e.message}`);
                }
            }
        });
        
        modalCancelBtn.addEventListener('click', closeModal);
        managementModal.addEventListener('click', e => {
            if (e.target === managementModal) closeModal();
        });

        document.querySelector('.file-list-table tbody').addEventListener('click', e => {
            const button = e.target.closest('.action-btn');
            if (!button) return;

            const row = button.closest('tr');
            const filename = row.dataset.filename;
            const action = button.dataset.action;

            if (action === 'delete') {
                if (confirm(`Are you sure you want to delete ${filename}?`)) {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = `/delete/${filename}`;
                    form.innerHTML = `<input type="hidden" name="active_tab" value="manage">`;
                    document.body.appendChild(form);
                    form.submit();
                }
            } else if (['rename', 'password', 'lock'].includes(action)) {
                openModal(action, filename, {
                    rawPassword: row.dataset.rawPassword,
                    visitLimit: row.dataset.visitLimit,
                    visitCount: row.dataset.visitCount
                });
            }
        });

        document.getElementById('theme-switcher').addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });
    });
</script>
</body>
</html>